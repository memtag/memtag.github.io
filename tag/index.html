<!doctype html>

<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NFC Web</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;margin:28px auto;padding:20px;max-width:720px;}
    h1{font-size:1.4rem;margin-bottom:0.2rem}
    button,input,select{padding:8px;margin:4px 0;border-radius:6px;border:1px solid #ccc;width:100%;cursor:pointer}
    pre{background:#f4f4f4;padding:10px;border-radius:6px;overflow:auto}
    .panel{border:1px solid #ccc;padding:14px;border-radius:8px;margin:12px 0}
    label{font-weight:600}
    .subpanel{margin-left:12px;margin-top:6px;}
  </style>
</head>
<body>
  <h1>NFC Web</h1>
  <div class="panel" id="status">Перевірка підтримки NFC...</div>
  <div class="panel" id="tag-panel" style="display:none">
    <pre id="tag-info">Дані з тегу...</pre>
    <div class="panel">
      <h2>Функції</h2>
      <p>Запис:</p>
      <ul>
        <li>Текст</li>
        <li>Посилання</li>
        <li>Звук</li>
      </ul>
      <div class="subpanel">
        <label for="write-text">Текст</label>
        <input id="write-text" placeholder="Текст для запису"/>
        <label for="write-url">Посилання</label>
        <input id="write-url" placeholder="https://example.com"/>
        <label for="write-sound">Звук</label>
        <select id="write-sound"></select>
      </div>
      <button id="btn-write">Записати вибране</button>
      <button id="btn-clear">Очистити тег</button>
      <pre id="log">Лог дій...</pre>
    </div>
  </div>  <script>
    const statusEl = document.getElementById('status');
    const tagPanel = document.getElementById('tag-panel');
    const tagInfo = document.getElementById('tag-info');
    const logEl = document.getElementById('log');
    const writeText = document.getElementById('write-text');
    const writeUrl = document.getElementById('write-url');
    const writeSound = document.getElementById('write-sound');
    const btnWrite = document.getElementById('btn-write');
    const btnClear = document.getElementById('btn-clear');

    let ndef = null;

    function log(msg){
      const ts = new Date().toLocaleTimeString();
      logEl.textContent = ts + ' — ' + msg + '\n' + logEl.textContent;
    }

    async function loadSounds(){
      try{
        const resp = await fetch('snd.txt');
        const text = await resp.text();
        const lines = text.split('\n');
        lines.forEach(line=>{
          const m = line.match(/name="([^"]+)"\s+page="([^"]+)"/);
          if(m){
            const opt = document.createElement('option');
            opt.value = `https://memtag.github.io/${m[2]}/`;
            opt.textContent = m[1];
            writeSound.appendChild(opt);
          }
        });
      }catch(e){
        log('Не вдалося завантажити snd.txt');
      }
    }

    async function startScan(){
      if(!('NDEFReader' in window)){
        statusEl.textContent = 'Ваш браузер не підтримує NFC';
        return;
      }
      ndef = new NDEFReader();
      try{
        await ndef.scan();
        statusEl.textContent = 'Прикладіть мітку';
        ndef.onreading = event => {
          const serial = event.serialNumber || 'не відомо';
          let type = 'Невідомий';
          let contentArr = [];
          for(const record of event.message.records){
            if(record.recordType==='text') contentArr.push(new TextDecoder().decode(record.data));
            else if(record.recordType==='url') contentArr.push(new TextDecoder().decode(record.data));
            else contentArr.push('');
          }
          if(event.message.records.length===0) contentArr.push('');

          // Визначення типу (за recordType)
          const types = event.message.records.map(r=>r.recordType);
          if(types.length===0) type='Невідомий';
          else if(types.length===1){
            if(types[0]==='text') type='Text';
            else if(types[0]==='url') type='URL';
            else type='Інший';
          } else {
            type='Змішаний';
          }

          tagInfo.textContent = `Дані:\nТип: ${type}\nUID: ${serial}\nЗміст: ${contentArr.join(', ')}`;
          tagPanel.style.display='block';
        };
      }catch(e){
        statusEl.textContent='Помилка при скануванні: '+e;
      }
    }

    btnWrite.addEventListener('click', async ()=>{
      if(!ndef) return;
      const records = [];
      if(writeText.value.trim()) records.push({recordType:'text', data:writeText.value.trim()});
      if(writeUrl.value.trim()) records.push({recordType:'url', data:writeUrl.value.trim()});
      if(writeSound.value) records.push({recordType:'url', data:writeSound.value});
      try{
        await ndef.write({records});
        log('Записано успішно');
      }catch(e){
        log('Помилка запису: '+e);
      }
    });

    btnClear.addEventListener('click', async ()=>{
      if(!ndef) return;
      try{
        await ndef.write({records:[]});
        log('Тег очищено');
      }catch(e){
        log('Помилка очищення: '+e);
      }
    });

    loadSounds();
    startScan();
  </script></body>
</html>
