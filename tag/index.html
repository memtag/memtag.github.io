<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MemTag NFC</title>
  <style>
    * {
      box-sizing: border-box;
      transition: all 0.2s ease;
    }
    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: #121212;
      color: #e0e0e0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      overflow: hidden;
      text-align: center;
    }
    #lang {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #1e1e1e;
      border: none;
      color: #fff;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }
    img {
      width: 180px;
      height: 180px;
      margin-bottom: 20px;
      opacity: 0.9;
    }
    h1 {
      font-size: 26px;
      margin-bottom: 20px;
    }
    .info {
      font-size: 18px;
      margin-top: 8px;
      word-break: break-all;
    }
    .btn {
      background: #2c2c2c;
      color: #fff;
      border: none;
      padding: 14px 30px;
      border-radius: 10px;
      font-size: 18px;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .btn:hover {
      background: #3a3a3a;
    }
    .hidden {
      display: none;
    }
    footer {
      position: fixed;
      bottom: 20px;
      display: flex;
      gap: 15px;
    }
    footer button {
      background: #2c2c2c;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 18px;
      font-size: 16px;
    }
    footer button:hover {
      background: #3a3a3a;
    }
  </style>
</head>
<body>
  <button id="lang">EN</button>

  <div id="screen">
    <img id="nfcImage" src="nfc.png" alt="NFC">
    <h1 id="status">Tap a tag</h1>
    <div class="info" id="uid"></div>
    <div class="info" id="type"></div>
    <div class="info" id="content"></div>
  </div>

  <button class="btn" id="mainButton">Skip</button>

  <footer class="hidden" id="footer">
    <button onclick="window.open('https://tiktok.com/@mem.tag','_blank')">TikTok</button>
    <button onclick="window.open('https://t.me/mem_soundtag','_blank')">Telegram</button>
  </footer>

  <script>
    // === Multilanguage ===
    const langBtn = document.getElementById("lang");
    const statusEl = document.getElementById("status");
    const uidEl = document.getElementById("uid");
    const typeEl = document.getElementById("type");
    const contentEl = document.getElementById("content");
    const mainBtn = document.getElementById("mainButton");
    const nfcImage = document.getElementById("nfcImage");
    const footer = document.getElementById("footer");

    const texts = {
      en: {
        tap: "Tap a tag",
        skip: "Skip",
        cancel: "Cancel",
        waiting: "Waiting for tag...",
        reading: "Reading tag...",
        writing: "Waiting for tag to write...",
        unsupported: "Your browser doesn't support NFC",
        uid: "UID:",
        type: "Content Type:",
        content: "Content:",
        mixed: "Mixed",
        unknown: "Unknown",
        error: "Error",
        back: "Return"
      },
      ua: {
        tap: "Прикладіть мітку",
        skip: "Пропустити",
        cancel: "Скасувати",
        waiting: "Очікую мітку...",
        reading: "Зчитую мітку...",
        writing: "Очікую мітку для запису...",
        unsupported: "Ваш браузер не підтримує NFC",
        uid: "UID:",
        type: "Тип змісту:",
        content: "Зміст:",
        mixed: "Змішане",
        unknown: "Невідомо",
        error: "Помилка",
        back: "Повернутися"
      },
      ru: {
        tap: "Приложите метку",
        skip: "Пропустить",
        cancel: "Отмена",
        waiting: "Ожидаю метку...",
        reading: "Читаю метку...",
        writing: "Ожидаю метку для записи...",
        unsupported: "Ваш браузер не поддерживает NFC",
        uid: "UID:",
        type: "Тип содержимого:",
        content: "Содержимое:",
        mixed: "Смешанное",
        unknown: "Неизвестно",
        error: "Ошибка",
        back: "Вернуться"
      }
    };

    let currentLang = "en";
    function setLang(lang) {
      currentLang = lang;
      langBtn.textContent = lang.toUpperCase();
      statusEl.textContent = texts[lang].tap;
      mainBtn.textContent = texts[lang].skip;
    }

    langBtn.onclick = () => {
      currentLang = currentLang === "en" ? "ua" : currentLang === "ua" ? "ru" : "en";
      setLang(currentLang);
    };

    // Detect browser language
    const browserLang = navigator.language.startsWith("uk")
      ? "ua"
      : navigator.language.startsWith("ru")
      ? "ru"
      : "en";
    setLang(browserLang);

    // === NFC Logic ===
    async function startNFC() {
      if (!("NDEFReader" in window)) {
        showError(texts[currentLang].unsupported);
        return;
      }
      try {
        const ndef = new NDEFReader();
        await ndef.scan();
        statusEl.textContent = texts[currentLang].tap;
        ndef.onreading = async event => {
          navigator.vibrate(100);
          const uid = event.serialNumber || "—";
          const records = event.message.records;
          let type = texts[currentLang].unknown;
          let content = texts[currentLang].unknown;

          if (records.length) {
            const decoder = new TextDecoder();
            const first = records[0];
            const data = decoder.decode(first.data);
            if (first.recordType === "url" && data.includes("memtag.github.io")) {
              type = "Sound";
              content = await resolveSoundName(data);
            } else if (first.recordType === "url") {
              type = "URL";
              content = data;
            } else if (first.recordType === "text") {
              type = "Text";
              content = data;
            } else {
              type = texts[currentLang].mixed;
              content = texts[currentLang].unknown;
            }
          }

          showMenu(uid, type, content);
        };
      } catch (err) {
        showError(texts[currentLang].error);
      }
    }

    async function resolveSoundName(url) {
      try {
        const res = await fetch("snd.txt");
        const txt = await res.text();
        const lines = txt.split("\n");
        const match = lines.find(line => line.includes(`page="${url.split("/").pop()}"`));
        if (match) {
          const name = match.match(/name="([^"]+)"/);
          return name ? name[1] : url;
        }
      } catch {}
      return url;
    }

    function showMenu(uid, type, content) {
      nfcImage.src = "nfc.png";
      uidEl.textContent = `${texts[currentLang].uid} ${uid}`;
      typeEl.textContent = `${texts[currentLang].type} ${type}`;
      contentEl.textContent = `${texts[currentLang].content} ${content}`;
      statusEl.textContent = "";
      footer.classList.remove("hidden");
      mainBtn.textContent = texts[currentLang].cancel;
    }

    function showError(msg) {
      nfcImage.src = "error.png";
      statusEl.textContent = msg;
      uidEl.textContent = "";
      typeEl.textContent = "";
      contentEl.textContent = "";
      mainBtn.textContent = texts[currentLang].back;
    }

    mainBtn.onclick = () => {
      if (mainBtn.textContent === texts[currentLang].skip) {
        showMenu("—", texts[currentLang].unknown, texts[currentLang].unknown);
      } else if (mainBtn.textContent === texts[currentLang].back) {
        resetScreen();
      } else {
        resetScreen();
      }
    };

    function resetScreen() {
      footer.classList.add("hidden");
      nfcImage.src = "nfc.png";
      uidEl.textContent = "";
      typeEl.textContent = "";
      contentEl.textContent = "";
      mainBtn.textContent = texts[currentLang].skip;
      statusEl.textContent = texts[currentLang].tap;
      startNFC();
    }

    startNFC();
  </script>
</body>
</html>
