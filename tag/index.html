<!doctype html>

<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NFC Web</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;margin:28px auto;padding:20px;max-width:720px;}
    h1{font-size:1.4rem;margin-bottom:0.2rem}
    button,input,select{padding:8px;margin:4px 0;border-radius:6px;border:1px solid #ccc;width:100%;cursor:pointer}
    pre{background:#f4f4f4;padding:10px;border-radius:6px;overflow:auto}
    .panel{border:1px solid #ccc;padding:14px;border-radius:8px;margin:12px 0}
    label{font-weight:600}
    .subpanel{margin-left:12px;margin-top:6px;display:none;}
  </style>
</head>
<body>
  <h1>NFC Web</h1>
  <div class="panel" id="status">Перевірка підтримки NFC...</div>
  <div class="panel" id="tag-panel" style="display:none">
    <pre id="tag-info">Дані з тегу...</pre>
    <div class="panel">
      <h2>Функції</h2>
      <label for="record-type">Що записати:</label>
      <select id="record-type">
        <option value="text">Текст</option>
        <option value="url">Посилання</option>
        <option value="sound">Звук</option>
      </select>
      <div class="subpanel" id="text-panel">
        <label for="write-text">Текст</label>
        <input id="write-text" placeholder="Текст для запису"/>
      </div>
      <div class="subpanel" id="url-panel">
        <label for="write-url">Посилання</label>
        <input id="write-url" placeholder="https://example.com"/>
      </div>
      <div class="subpanel" id="sound-panel">
        <label for="write-sound">Звук</label>
        <select id="write-sound"></select>
      </div>
      <button id="btn-write">Записати вибране</button>
      <button id="btn-clear">Очистити тег</button>
      <pre id="log">Лог дій...</pre>
    </div>
  </div>  <script>
    const statusEl = document.getElementById('status');
    const tagPanel = document.getElementById('tag-panel');
    const tagInfo = document.getElementById('tag-info');
    const logEl = document.getElementById('log');
    const writeText = document.getElementById('write-text');
    const writeUrl = document.getElementById('write-url');
    const writeSound = document.getElementById('write-sound');
    const btnWrite = document.getElementById('btn-write');
    const btnClear = document.getElementById('btn-clear');
    const recordTypeSel = document.getElementById('record-type');
    const textPanel = document.getElementById('text-panel');
    const urlPanel = document.getElementById('url-panel');
    const soundPanel = document.getElementById('sound-panel');

    let ndef = null;

    function log(msg){
      const ts = new Date().toLocaleTimeString();
      logEl.textContent = ts + ' — ' + msg + '\n' + logEl.textContent;
    }

    function showSubPanel(){
      textPanel.style.display='none';
      urlPanel.style.display='none';
      soundPanel.style.display='none';
      if(recordTypeSel.value==='text') textPanel.style.display='block';
      else if(recordTypeSel.value==='url') urlPanel.style.display='block';
      else if(recordTypeSel.value==='sound') soundPanel.style.display='block';
    }

    recordTypeSel.addEventListener('change', showSubPanel);

    async function loadSounds(){
      try{
        const resp = await fetch('snd.txt');
        const text = await resp.text();
        const lines = text.split('\n');
        lines.forEach(line=>{
          const m = line.match(/name="([^"]+)"\s+page="([^"]+)"/);
          if(m){
            const opt = document.createElement('option');
            opt.value = `https://memtag.github.io/${m[2]}/`;
            opt.textContent = m[1];
            writeSound.appendChild(opt);
          }
        });
      }catch(e){
        log('Не вдалося завантажити snd.txt');
      }
    }

    async function startScan(){
      if(!('NDEFReader' in window)){
        statusEl.textContent = 'Ваш браузер не підтримує NFC';
        return;
      }
      ndef = new NDEFReader();
      try{
        await ndef.scan();
        statusEl.textContent = 'Прикладіть мітку';
        ndef.onreading = event => {
          const serial = event.serialNumber || 'не відомо';
          let contentArr = [];
          for(const record of event.message.records){
            try{
              if(record.recordType==='text') contentArr.push(new TextDecoder().decode(record.data));
              else if(record.recordType==='url') contentArr.push(new TextDecoder().decode(record.data));
              else {
                // якщо не зрозумілий recordType — спробуємо декодувати будь-які дані
                try{ contentArr.push(new TextDecoder().decode(record.data || new Uint8Array([]))); }catch(e){ contentArr.push(''); }
              }
            }catch(e){
              contentArr.push('');
            }
          }

          let contentStr;
          if(contentArr.length===0 || contentArr.every(c=>c==='')) contentStr='Порожнє';
          else if(contentArr.every(c=>/^https?:\/\//.test(c))) contentStr='URL';
          else if(contentArr.every(c=>c!=='' && !/^https?:\/\//.test(c))) contentStr='Text';
          else contentStr='Змішане';

          tagInfo.textContent = `Дані:\nUID: ${serial}\nЗміст: ${contentStr}`;
          tagPanel.style.display='block';
        };
      }catch(e){
        statusEl.textContent='Помилка при скануванні: '+e;
      }
    }

    btnWrite.addEventListener('click', async ()=>{
      if(!ndef) return;
      const type = recordTypeSel.value;
      let records = [];
      if(type==='text' && writeText.value.trim()) records.push({recordType:'text', data:writeText.value.trim()});
      else if(type==='url' && writeUrl.value.trim()) records.push({recordType:'url', data:writeUrl.value.trim()});
      else if(type==='sound' && writeSound.value) records.push({recordType:'url', data:writeSound.value});
      else {log('Немає даних для запису'); return;}

      try{
        await ndef.write({records});
        log('Записано успішно');
      }catch(e){
        log('Помилка запису: '+e);
      }
    });

    btnClear.addEventListener('click', async ()=>{
      if(!ndef) return;
      try{
        await ndef.write({records:[]});
        log('Тег очищено');
      }catch(e){
        log('Помилка очищення: '+e);
      }
    });

    loadSounds();
    showSubPanel();
    startScan();
  </script></body>
</html>
